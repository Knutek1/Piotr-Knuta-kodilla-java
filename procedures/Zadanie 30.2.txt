DROP PROCEDURE IF EXISTS UpdateBestsellers;

DELIMITER $$

CREATE PROCEDURE UpdateBestsellers()
BEGIN
DECLARE rented, b_Id INT;
DECLARE FINISHED INT DEFAULT 0;
DECLARE ALL_BOOKS CURSOR FOR SELECT BOOK_ID FROM books;
DECLARE CONTINUE HANDLER FOR NOT FOUND SET FINISHED = 1;
OPEN ALL_BOOKS;
WHILE (FINISHED = 0) DO
FETCH ALL_BOOKS INTO b_Id;
IF (FINISHED = 0) THEN
SELECT COUNT(*) FROM RENTS
WHERE BOOK_ID = b_Id
INTO rented;

UPDATE books SET BESTSELLER = bestsellerTitle(rented)
WHERE BOOK_ID = b_Id;
COMMIT;
END IF;
END WHILE;

CLOSE ALL_BOOKS;
END $$

DELIMITER ;
CALL UpdateBestsellers();
SELECT * from books;

DROP FUNCTION IF EXISTS bestsellerTitle;
DELIMITER $$
CREATE function bestsellerTitle(numberOfRents int) returns boolean deterministic
BEGIN
IF numberOfRents > 2 THEN
RETURN TRUE;
ELSE
RETURN FALSE;
END IF;
END $$
DELIMITER ;